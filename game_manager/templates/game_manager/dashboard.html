<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    {% load dashboard_filters %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Server Dashboard</title>
    <link rel="stylesheet" href="{% static 'game_manager/css/dashboard.css' %}">
</head>

<body>
    <div class="container">
        <div class="header"
            style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h1>üéÆ Server Orchestrator Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <span class="timestamp">üïê Server: {{ server_time|date:"Y-m-d H:i:s" }} UTC</span>
                <div class="refresh-control" style="display: flex; align-items: center; gap: 10px;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="refreshEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Auto-refresh</span>
                    <input type="range" class="refresh-slider" id="refreshSlider" min="2" max="120" value="10">
                    <span class="refresh-label" id="refreshLabel">10s</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">üåô Night Mode</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card info">
                <h3>Queue Size</h3>
                <div class="value">{{ queue_size }}</div>
                <div class="subtext">Pending planets</div>
                <button class="btn-assign" onclick="forceAssign()" style="margin-top: 10px;">‚ö° Force Assign</button>
            </div>

            <div class="stat-card success">
                <h3>Total Servers</h3>
                <div class="value">{{ total_servers }}</div>
                <div class="subtext">{{ idle_servers }} idle / {{ busy_servers }} busy</div>
            </div>

            <div
                class="stat-card {% if success_rate >= 90 %}success{% elif success_rate >= 70 %}warning{% else %}danger{% endif %}">
                <h3>Success Rate</h3>
                <div class="value">{{ success_rate }}%</div>
                <div class="subtext">{{ completed_tasks }}/{{ total_tasks }} completed</div>
            </div>

            <div class="stat-card info">
                <h3>Avg Duration</h3>
                <div class="value">{{ avg_duration }}s</div>
                <div class="subtext">Per completed task</div>
            </div>
        </div>

        <!-- Servers Section -->
        <div class="section">
            <h2>üñ•Ô∏è Game Servers ({{total_servers}})</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Server ID</th>
                            <th>Status</th>
                            <th>Last Heartbeat</th>
                            <th>Current Task</th>
                            <th>CPU (idle‚Üímax)</th>
                            <th>RAM (idle‚Üímax)</th>
                            <th>Disk</th>
                            <th>Completed/Assigned</th>
                            <th>Failed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for server in servers %}
                        <tr>
                            <td><strong>{{ server.server_id|mask_ip }}</strong></td>
                            <td><span class="badge {{ server.status }}">{{ server.status }}</span></td>
                            <td class="timestamp">
                                {% if server.last_heartbeat %}
                                <span class="heartbeat-ago"
                                    data-timestamp="{{ server.last_heartbeat.isoformat }}">--</span>
                                {% else %}
                                <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if server.current_task %}
                                <strong>Planet {{ server.current_task.planet_id }}</strong>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ server.idle_cpu_usage|floatformat:0 }}% ‚Üí {{ server.max_cpu_usage|floatformat:0 }}%
                            </td>
                            <td>{{ server.idle_ram_usage|floatformat:0 }}% ‚Üí {{ server.max_ram_usage|floatformat:0 }}%
                            </td>
                            <td>{{ server.disk_usage|floatformat:1 }}%</td>
                            <td>{{ server.total_completed_planet }} / {{ server.total_assigned_planet }}</td>
                            <td>
                                {% if server.total_failed_planet > 0 %}
                                <span style="color: #e74c3c; font-weight: bold;">{{ server.total_failed_planet }}</span>
                                {% else %}
                                <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-restart"
                                    onclick="sendCommand('{{ server.server_id }}', 'restart_server')">Restart</button>
                                {% if server.status == 'busy' %}
                                <button class="btn-cancel"
                                    onclick="sendCommand('{{ server.server_id }}', 'stop_game')">Cancel</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="no-data">No servers connected</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Maps Queue Section -->
        <div class="section">
            <h2>üó∫Ô∏è Planet Queue / Active Tasks ({{ planets|length }})</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Planet ID</th>
                            <th>Status</th>
                            <th>Next Round Time</th>
                            <th>Current Season ID</th>
                            <th>Current Round ID</th>
                            <th>Current Round Number</th>
                            <th>Processing Server</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for planet in planets %}
                        <tr>
                            <td><strong>{{ planet.planet_id }}</strong></td>
                            <td><span class="badge {{ planet.status }}">{{ planet.status }}</span></td>
                            <td>
                                <span class="timestamp">{{ planet.next_round_time|date:"Y-m-d H:i:s" }}</span>
                                <br><span class="countdown"
                                    data-target="{{ planet.next_round_time.isoformat }}">--:--:--</span>
                            </td>
                            <td>{{ planet.season_id }}</td>
                            <td>{{ planet.round_id }}</td>
                            <td>{{ planet.current_round_number }}</td>
                            <td>
                                {% if planet.processing_server %}
                                {{ planet.processing_server.server_id|mask_ip }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="no-data">No active planets</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Task History Section -->
        <div class="section">
            <h2 style="display: flex; justify-content: space-between; align-items: center;">
                <span>üìä Task History (Recent 50)</span>
                <a href="/task-history/"
                    style="font-size: 14px; color: #9b59b6; text-decoration: none; font-weight: normal;">View All ‚Üí</a>
            </h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Planet ID</th>
                            <th>Server</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in recent_tasks %}
                        <tr>
                            <td><strong>{{ task.planet.planet_id }}</strong></td>
                            <td>
                                {% if task.server %}
                                {{ task.server.server_id|mask_ip }}
                                {% else %}
                                <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td><span class="badge {{ task.status }}">{{ task.status }}</span></td>
                            <td class="timestamp">{{ task.start_time|timesince }} ago</td>
                            <td>
                                {% if task.duration_seconds %}
                                {{ task.duration_seconds|floatformat:2 }}s
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-muted">
                                {% if task.error_message %}
                                {{ task.error_message }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="no-data">No task history available</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function sendCommand(serverId, action) {
            if (!confirm(`Are you sure you want to ${action} on ${serverId}?`)) return;

            fetch('/api/command/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    server_id: serverId,
                    action: action
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Command sent successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to send command');
                });
        }

        function forceAssign() {
            fetch('/api/force-assign/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to trigger assignment');
                });
        }

        // Theme toggle function
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è Day Mode' : 'üåô Night Mode';
        }

        // Detect system theme preference or use saved preference
        function initTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Use saved preference if exists, otherwise use system preference
            const isDark = savedTheme !== null ? savedTheme === 'true' : systemDark;

            if (isDark) {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è Day Mode';
            }
        }
        initTheme();

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('darkMode') === null) {
                // Only auto-switch if user hasn't manually set preference
                if (e.matches) {
                    document.body.classList.add('dark-mode');
                    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è Day Mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.querySelector('.theme-toggle').textContent = 'üåô Night Mode';
                }
            }
        });

        // Real-time countdown timer
        function updateCountdowns() {
            document.querySelectorAll('.countdown').forEach(el => {
                const target = new Date(el.dataset.target);
                const now = new Date();
                const diff = target - now;

                if (diff <= 0) {
                    el.textContent = 'READY';
                    el.classList.add('overdue');
                } else {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const secs = Math.floor((diff % (1000 * 60)) / 1000);
                    el.textContent = `${hours}h ${mins}m ${secs}s`;
                    el.classList.remove('overdue');
                }
            });
        }
        updateCountdowns();
        setInterval(updateCountdowns, 1000);

        // Real-time heartbeat update (in seconds)
        function updateHeartbeats() {
            document.querySelectorAll('.heartbeat-ago').forEach(el => {
                const timestamp = new Date(el.dataset.timestamp);
                const now = new Date();
                const diffMs = now - timestamp;
                const diffSeconds = Math.floor(diffMs / 1000);

                if (diffSeconds < 60) {
                    el.textContent = `${diffSeconds}s ago`;
                } else if (diffSeconds < 3600) {
                    const mins = Math.floor(diffSeconds / 60);
                    const secs = diffSeconds % 60;
                    el.textContent = `${mins}m ${secs}s ago`;
                } else {
                    const hours = Math.floor(diffSeconds / 3600);
                    const mins = Math.floor((diffSeconds % 3600) / 60);
                    el.textContent = `${hours}h ${mins}m ago`;
                }
            });
        }
        updateHeartbeats();
        setInterval(updateHeartbeats, 1000);

        // Auto-refresh slider control
        const slider = document.getElementById('refreshSlider');
        const label = document.getElementById('refreshLabel');
        const enabledCheckbox = document.getElementById('refreshEnabled');
        let refreshTimer = null;

        function setRefreshInterval(seconds, enabled = true) {
            if (refreshTimer) clearTimeout(refreshTimer);
            label.textContent = seconds + 's';
            localStorage.setItem('refreshInterval', seconds);
            localStorage.setItem('refreshEnabled', enabled);

            if (enabled) {
                refreshTimer = setTimeout(() => location.reload(), seconds * 1000);
                slider.disabled = false;
                slider.style.opacity = '1';
            } else {
                slider.disabled = true;
                slider.style.opacity = '0.5';
            }
        }

        // Load saved preferences
        const savedInterval = localStorage.getItem('refreshInterval') || 10;
        const savedEnabled = localStorage.getItem('refreshEnabled') !== 'false';
        slider.value = savedInterval;
        enabledCheckbox.checked = savedEnabled;
        setRefreshInterval(parseInt(savedInterval), savedEnabled);

        slider.addEventListener('input', (e) => {
            setRefreshInterval(parseInt(e.target.value), enabledCheckbox.checked);
        });

        enabledCheckbox.addEventListener('change', (e) => {
            setRefreshInterval(parseInt(slider.value), e.target.checked);
        });
    </script>
</body>

</html>